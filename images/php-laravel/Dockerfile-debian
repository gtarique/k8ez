# Use an official PHP image with PHP-FPM support
FROM php:8.1-fpm

# Install system dependencies, PHP extensions, and Supervisor
RUN apt-get update && apt-get install -y \
    libpng-dev \
    libjpeg-dev \
    libfreetype6-dev \
    libzip-dev \
    apache2 \
    supervisor \
    && docker-php-ext-configure gd --with-freetype --with-jpeg \
    && docker-php-ext-install -j$(nproc) gd pdo pdo_mysql zip \
    && a2enmod rewrite proxy proxy_fcgi \
    && rm -rf /var/lib/apt/lists/*

# Configure Apache as a reverse proxy to PHP-FPM
RUN echo "ProxyPassMatch ^/(.*\.php(/.*)?)$ fcgi://127.0.0.1:9000/var/www/app/public/$1" > /etc/apache2/conf-available/php-fpm-proxy.conf && \
    a2enconf php-fpm-proxy

# Copy Supervisor configuration file
COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf

# Create a non-root user and give access to the app directory
RUN groupadd -r limitedaccessaccount && useradd -r -g limitedaccessaccount limitedaccessaccount \
    && mkdir -p /var/www/app /var/log/php /var/log/apache2 \
    && chown -R limitedaccessaccount:limitedaccessaccount /var/www/app /var/log/php /var/log/apache2 \
    && chmod -R 755 /var/www/app

# Set the working directory
WORKDIR /var/www/app

# Ensure the log directories exist
RUN chown www-data:www-data /var/log/php /var/log/apache2

# Switch to the non-root user
USER limitedaccessaccount

# Expose port 80 for Apache
EXPOSE 80

USER root

# Start services using Supervisor
CMD ["supervisord", "-c", "/etc/supervisor/conf.d/supervisord.conf"]
